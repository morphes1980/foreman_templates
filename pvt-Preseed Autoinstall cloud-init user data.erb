<%#
kind: user_data
name: pvt-Preseed Autoinstall cloud-init user data
model: ProvisioningTemplate
oses:
- ubuntu
test_on:
- ubuntu_autoinst4dhcp
description: |
  The provisioning template for Autoinstall based distributions. To customize the installation,
  modify the host parameters

  This template accepts the following parameters:
  - lang: string (default="en_US.UTF-8")
  - keyboard: string (default="de")
  - package_upgrade: boolean (default=false)
  - remote_execution_ssh_keys: string (default="")
  - username_to_create: string (default="root")
  - realname_to_create: string (default=username_to_create)
  - password_to_create: string (default=@host.root_pass)
-%>
<%-
username_to_create = host_param('username_to_create', 'root')
realname_to_create = host_param('realname_to_create') || username_to_create
password_to_create = host_param('password_to_create') || @host.root_pass
enable_auto_update = (host_param_true?('package_upgrade') && !host_param('kt_activation_keys'))
-%>
#cloud-config
autoinstall:
  version: 1
  Mirror:
    mirror: "http://foreman.speedport.ip"
  apt:
    geoip: false
    preserve_sources_list: false
    primary:
      - arches: [amd64, i386]
        uri: http://archive.ubuntu.com/ubuntu
<% unless enable_auto_update -%>
    disable_components: [multiverse]
    disable_suites: [backports,security,updates] 
<% end -%>
  user-data:
    hostname: <%= @host.name %>
    users:
      - name: morphes
        shell: /bin/bash
        passwd: <%= password_to_create %>
        lock-passwd: false
        groups: [sudo]
      - name: <%= host_param('remote_execution_ssh_user') %>
        shell: /bin/bash
        lock-passwd: true
        groups: [sudo]
<%= indent(4) { snippet_if_exists(template_name + " custom apt") } -%>
<% if !host_param('p-remote_execution_ssh_keys').blank? -%>
<%   if host_param('p-remote_execution_ssh_keys').is_a?(String) -%>
        ssh_authorized_keys: [<%= host_param('p-remote_execution_ssh_keys') %>]
<%   else -%>
        ssh_authorized_keys: <%= host_param('p-remote_execution_ssh_keys') %>
<%   end -%>
<% else -%>
        #ssh_authorized_keys: []
<% end -%>
  keyboard:
    layout: <%= host_param('keyboard', 'de') %>
    toggle: null
    variant: ''
  locale: <%= host_param('lang', 'en_US') %>.UTF-8
<%= snippet 'preseed_netplan_setup' -%>
  ssh:
    allow-pw: true
    install-server: true
  updates: security
<%= indent(2) { @host.diskLayout } -%>
<%= indent(2) { snippet_if_exists(template_name + " custom root") } -%>
#  late-commands:
#    - wget -Y off <%= @static ? "'#{foreman_url('finish', static: 'true')}'" : foreman_url('finish') %> -O /target/tmp/finish.sh
#    - curtin in-target -- chmod +x /tmp/finish.sh
#    - curtin in-target -- /tmp/finish.sh
#    - curtin in-target --target=/target -- apt update           
#    - curtin in-target --target=/target -- apt upgrade -y
